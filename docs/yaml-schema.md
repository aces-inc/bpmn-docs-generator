# 業務プロセス図 YAML スキーマ

YAML で BPMN 風の業務プロセス（スイムレーン・タスク・分岐・フロー）を定義し、編集可能な PPTX に変換するためのスキーマです。

## 概要

- **actors**: スイムレーン（アクター）の名前を並べたリスト。左から右の順でレーンが並ぶ。
- **nodes**: ノードを連番・リストで記述。各ノードは「ID」「タスク／分岐」「どのアクターか」「タスク内容」「接続先（番号）」を持つ。

## ルートキー

| キー | 必須 | 説明 |
|------|------|------|
| `actors` | ✅ | スイムレーン名のリスト。例: `["お客様", "IT営業", "社内"]`。**システム用レーン**にするアクターは接頭辞 `[システム]` または接尾辞 `_` を付けると、1本の「システム」レーンに集約される。 |
| `nodes` | ✅ | ノードのリスト。各要素は下記のノード形式 |
| `layout` | - | レイアウト設定。`margins`（余白）、`task_size_ratio`（タスクサイズ）、`max_cols_per_slide`（列数）、`task_font_pt` / `actor_font_pt` / `label_font_pt`（フォントサイズ）を指定可能。未指定時は現行どおり。 |

### layout.margins（余白）

スライドの余白を pt で指定する。未指定のキーは従来どおりの既定値が使われる。

| キー | 説明 |
|------|------|
| `left_pt` | 左余白（pt）。最小 10pt を維持。 |
| `right_pt` | 右余白（pt）。最小 10pt を維持。 |
| `top_pt` | 上余白（pt）。図の描画開始位置。 |
| `bottom_pt` | 下余白（pt）。図の下端からスライド下縁まで。 |

### layout のその他オプション（タスクサイズ・列数・フォント）

| キー | 説明 |
|------|------|
| `task_size_ratio` | タスク一辺のレーン高さに対する比率（0.2～1.0）。未指定時は 0.6。大きくするとタスクが広く表示される。 |
| `max_cols_per_slide` | 1 スライドあたりの最大タスク列数。未指定時はスライド幅から自動計算（約 8 列）。9 列などに固定したい場合に指定する。 |
| `task_font_pt` | タスク・ノード内テキストのフォントサイズ（pt）。未指定時は 10。最小 6pt まで指定可能。 |
| `actor_font_pt` | アクター名のフォントサイズ（pt）。未指定時は 10。 |
| `label_font_pt` | 矢印ラベル（分岐の Yes/No、システム接続のアクション名等）のフォントサイズ（pt）。未指定時は 8。 |

- **アクターが少ないとき**: アクター数が 2～4 のとき、描画領域の高さをレーンに割り当てて縦に広げ、タスクは指定サイズのままレーン内で中央配置される。
- **スイムレーン区切り線**: レーン間のグレー点線は、アクター四角の境界（四角と四角の間）に描画される。アクター四角の描画高さ（lane_height）と区切り線の Y 座標は一致している。

## ノード形式

各ノードは次のキーで記述する。

| キー | 必須 | 説明 |
|------|------|------|
| `id` | ✅ | ノードの一意識別子。数値または文字列。接続先の参照に使う。 |
| `type` | ✅ | `task`（タスク）、`gateway`（分岐）、`start`（開始）、`end`（終了）、`artifact`（成果物）、`service`（システム接続用のサービス）。開始・終了は正円、成果物はフローチャートのデータ図形、サービスは磁気ディスク図形で描画される。 |
| `gateway_type` | - | `gateway` のときのみ。`exclusive`（条件分岐・菱形に✕）または `parallel`（並行・菱形に＋）。省略時は `exclusive`。 |
| `actor` | ✅ | このノードが属するスイムレーン。アクター名（文字列）または 0 始まりのインデックス（整数） |
| `label` | ✅ | 表示するテキスト（タスク内容・分岐のラベルなど）。分岐は PPTX 上では ✕/＋ のみ表示。 |
| `next` | ✅ | 接続先ノードの ID のリスト。例: `[2, 3]`。分岐で矢印にラベル（Yes/No 等）を付ける場合は `[{ id: 2, label: "Yes" }, { id: 3, label: "No" }]` のようにオブジェクトで指定する。順序はフロー順。**ループ**: 開始ノードの ID を指定すると、そのタスクから開始ノードへ戻る矢印（ループ）が PPTX 上に描画される。 |
| `request_to` | - | システム接続。このタスクからリクエストを送るサービスノードの ID のリスト。`[svc]` のほか、矢印にアクション名を表示したい場合は `[{ id: svc, label: "リード登録" }]` のようにオブジェクトのリストで指定する。指定すると、人タスクからサービスへ点線（人側○・サービス側矢印）で描画され、`label` は矢印付近に表示される。 |
| `response_from` | - | システム接続。このタスクがレスポンスを受け取るサービスノードの ID のリスト。同様に `[{ id: svc, label: "結果取得" }]` でラベル付き指定可能。指定すると、サービスから人タスクへ下→上の点線で描画される。 |

## 例

```yaml
actors:
  - お客様
  - IT営業
  - 社内
  - 導入・サポート

nodes:
  - id: 1
    type: task
    actor: 0
    label: 要件検討
    next: [2]
  - id: 2
    type: gateway
    actor: 0
    label: 成約?
    next: [3, 4]
  - id: 3
    type: task
    actor: 1
    label: 契約手続き
    next: [5]
  - id: 4
    type: task
    actor: 0
    label: 見送り
    next: []
  - id: 5
    type: task
    actor: 2
    label: 契約審査
    next: [6]
  - id: 6
    type: task
    actor: 3
    label: キックオフ
    next: []
```

### システム用レーンの指定（DR-002）

次のいずれかのマークを付けたアクターは、**1本の「システム」スイムレーン**に集約される。

| マーク | 例 |
|--------|-----|
| **接頭辞** `[システム]` | `"[システム]API"`、`"[システム]外部"` |
| **接尾辞** `_`（アンダースコア） | `"CRM_"`、`"API_"` |

複数アクターにマークを付けても、PPTX 上では「システム」という1本のレーンになり、その中に `type: service` のノードの `label` から収集した**ユニークなシステム名**が並んで配置される。矢印は**タスクの下辺**から**システム図形の上辺**へ接続される。

## システム接続の例

人タスクからサービスへのリクエスト・レスポンスを表す場合。システム用レーンにするアクターは接頭辞や接尾辞でマークする。`request_to` / `response_from` は ID のリスト（`[svc]`）のほか、**`[{ id, label? }]`** 形式で書くと、矢印付近に「リード登録」「商談登録」などのアクション名が表示される。既存の「システムをアクターに見立てた task ノード」で書いている YAML は、`type: service` ノードと `request_to`（ラベル付き）の形に書き換えると、1本のシステムレーンに集約され、矢印にアクション名を出せる。

```yaml
actors:
  - 営業
  - "[システム]API"   # システム用レーンに集約（1本の「システム」として表示）
nodes:
  - id: 1
    type: task
    actor: 0
    label: 依頼
    next: [2]
    request_to: [{ id: svc, label: リード登録 }]
  - id: 2
    type: task
    actor: 0
    label: 確認
    next: []
    response_from: [{ id: svc, label: 結果取得 }]
  - id: svc
    type: service
    actor: 1
    label: API
```

## 制約・注意

- `next` で参照する ID は、同じ YAML 内のいずれかのノードの `id` と一致している必要がある。
- `actor` は `actors` のインデックス（0 始まり）か、`actors` に含まれる名前のいずれかで指定する。
- スキーマの厳密な検証は行わず、ベストエフォートで PPTX を生成する。
- **ループ**: タスクの `next` で開始ノードの ID を参照すると、フローが開始に戻るループとして描画される。開始ノードは常に左端（列0）に配置される。
- **成果物**: `type: artifact` のノードは、作成・保存する成果物を表す。PPTX 上ではフローチャートの「データ」図形で描画され、`label` に成果物名を記載する。
- **システム接続**: `type: service` のノードは、システムレーン内のサービスを表し、磁気ディスク図形で描画される。**接続ルール**: タスク側は**タスクの下辺**に矢印を結合、システム側は**システム図形の上辺**に矢印を結合する。人タスクに `request_to: [サービスID]` を指定するとリクエストの点線（人側○・サービス側矢印）、`response_from: [サービスID]` を指定するとレスポンスの点線（サービス上辺→タスク下辺）が描画される。列がずれる場合は L 字（elbow）点線になる。
- **矢印の接続点**: PPTX 上では、タスクから見て**左から入り右から出る**。同じ列のノード間（分岐先の縦並びなど）のときだけ上下で接続する。

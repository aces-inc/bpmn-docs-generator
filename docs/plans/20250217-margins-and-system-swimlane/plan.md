---
Created: 2025-02-17
Owner: x4066x
Status: draft
---

# 実装計画: 余白コンフィグ化とシステム用スイムレーン・接続ルール

## Goal

1. **余白のコンフィグ化**: スライドの左右・上下の余白をコンフィグで設定可能にし、縦横比の異なるスライドに柔軟に対応する。
2. **システム用スイムレーンと接続ルール**（別タスク群）: システムへの接続は「タスクの下から矢印・システムの上に接続」に統一し、システムを「アクター」スイムレーンに集約してユニークなシステム名で分割配置する。タスクから関係するシステムへ矢印を伸ばす形にし、アクター数を減らして縦横に伸ばしやすくする。

## Background / Motivation

- **余白**: 現状は `ProcessLayout` で左右 10pt 以上・上はスライド高さの約 25%・下は約 5% が固定。スライド縦横比が違うとレイアウトが合わないため、余白をコンフィグで指定できるようにしたい。
- **システム接続・スイムレーン**: 現在は「システム名＝1 アクター＝1 レーン」で、システムが多いとアクターが増え横に伸びる。システムを 1 本の「システム」スイムレーンにまとめ、その中に登場するユニークなシステム名を並べて配置し、タスクからは矢印で接続する形にすると、アクターが減り縦横の拡張がしやすくなる。接続は「タスクの下に矢印を結合・システムの上に矢印を結合」で統一する。

## Constraints

- **既存の YAML スキーマ・PPTX レイアウト仕様**（`docs/plans/20250207-process-to-pptx/plan.md` の Constraints）のうち、余白・システムレーンに抵触しない部分は維持する。
- 使用言語・ランタイムは既存どおり（Python + uv）。検証は README に従い `docker compose build` → `docker compose run convert` で行う。
- 余白コンフィグは、既存の「スライド左右 10pt 以上」等の DoD を**最小値として許容する**形で拡張する（コンフィグ未指定時は現状どおり）。

## Definition of Done

**Part 1: 余白のコンフィグ化**（先行。DR-001 を反映）

- [ ] 余白を**プロセス YAML** で指定できる。例: ルートに `layout: margins: { left_pt, right_pt, top_pt, bottom_pt }` 等。未指定時は現行の左右 10pt 以上・上約 25%・下約 5% を維持。
- [ ] 左右の余白（left_margin, right_margin）および上下（content_top_offset / bottom_margin 相当）がコンフィグで効く。指定した余白で `compute_layout` および PPTX 描画が一貫して使われ、意図どおり反映されている。
- [ ] 余白を変えたときも、既存の test_slide_margin_10pt 相当の検証（余白以上が確保されていること）が満たせるか、テストを調整している。
- [ ] **.cursor/skills/process-yaml/SKILL.md** に、余白コンフィグの**書き方**（どのキーをどこに書くか・単位・未指定時の挙動）を追記し、他の人も使いやすいように整理している。
- [ ] **docs/yaml-schema.md** に余白コンフィグの項目を反映している。

**Part 2: システム用スイムレーン・接続ルール**（DR-002・003 は一度に行わず、順に実施）

- [ ] **接続ルール**: システムへの接続は、タスク側は**タスクの下辺**に矢印を結合し、システム側は**システム図形の上辺**に矢印を結合する。
- [ ] **システム用レーンの指定**: 特定のアクターを「システム用」とみなす。方法は次のいずれかで決める（DR-002 で決定）: アクター名が「システム」など特定名である / アクター名にマーク（接頭辞・接尾辞など）を付ける。そのアクターが**システム用の 1 本のスイムレーン**となる。
- [ ] **システム用レーンの中身**: そのレーンには、process-yaml で出力される**ユニークなシステム名**（`type: service` のノードの `label` から収集）を並べて配置する。システム名が `actors` に含まれていても、その 1 本の「システム」レーンに集約して出力する形でよい（アクターに見立ててタスク風に配置できる）。
- [ ] 配置した各システムに対して、`request_to` / `response_from` で関係するタスクから矢印が伸びる。
- [ ] 上記により、システムごとに 1 レーンを割かずに済み、アクター数が減り、縦横に伸ばしたレイアウトが可能になっている。
- [ ] **docs/yaml-schema.md** および **.cursor/skills/process-yaml/SKILL.md** に、システム用レーンの指定方法（どのアクターがシステム用か）と YAML の書き方を反映している。

## Assumptions

- 余白コンフィグは**プロセス YAML** で渡す（他者も使いやすい）。未指定時は現行どおり。
- システム用スイムレーンは「特定のアクターをシステム用とマークする」形。そのアクターが 1 本のレーンとなり、その中にユニークなシステム名（`type: service` の `label`）を並べる。`actors` にシステム名が含まれていても、システム用とマークした 1 レーンに集約して出力する。
- **実装順序**: Part 1（DR-001＝余白 YAML + SKILL.md 整理）を先に実施する。DR-002・003（システム名の定義・既存 actors の扱い）は一度に行わず、002 を決めてから 003 を決めるなど、順に進める。

## Decision Required

| ID | 内容 | 選択肢 | Priority |
|----|------|--------|----------|
| ~~DR-001~~ | ~~余白コンフィグの指定方法~~ | **→ 決定: プロセス YAML（例: `layout: margins:`）で指定。SKILL.md に書き方を整理。** | - |
| DR-002 | どのアクターを「システム用レーン」とみなすか | アクター名が特定の名前（例: 「システム」）と一致する / アクター名にマークを付ける（例: 接頭辞 `[システム]` や接尾辞 `*`） | P0 |
| DR-003 | 既存 YAML でシステム名が actors に含まれている場合の出力 | システム用レーン 1 本にユニークシステム名を並べて出力（actors のシステム名はレーン名としては使わず、レーン内のシステム名表示に process から導出したユニーク名を使う） / その他 | P1 |

**注**: DR-002 を決めてから DR-003 を決める。002 と 003 は一度に行わない。

## References

- 親プラン・レイアウト仕様: `docs/plans/20250207-process-to-pptx/plan.md`
- 未完了 DoD 完了プラン: `docs/plans/20250211-process-pptx-remaining/plan.md`
- 入力例: `input/process.yaml`, `input/bank-sales.yaml`, `input/it-sales.yaml`
- スキーマ: `docs/yaml-schema.md`
- レイアウト計算: `process_to_pptx/yaml_loader.py`（ProcessLayout, compute_layout）
- 描画: `process_to_pptx/yaml2pptx.py`

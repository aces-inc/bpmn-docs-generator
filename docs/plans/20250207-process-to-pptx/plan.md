---
Created: 2025-02-07
Updated: 2025-02-09
Owner: x4066x
Status: draft
---

# 実装計画: YAML 駆動の業務プロセス図 → 編集可能な PPTX

## Goal

YAML で定義した業務プロセス（BPMN 風・スイムレーン）を、編集可能な図形として PPTX に変換する。YAML は人または AI が作成・編集し、プログラムが PPTX（必要に応じて mxGraph XML も）に変換する。最も効率的な出力が PPTX であれば PPTX を主とする。

## Background / Motivation

- **現状の課題**
  - 実態は「mxGraph XML から直接 PPTX に変換」しているが、名前や説明が「drawio から pptx」のように見え、紛らわしい。
  - 出力をそのまま使おうとしたところ、矢印が繋がっていないなど微妙な使い方になっていた。
  - BPMN で業務プロセスを作る際、タスクが増えると横に伸びるだけで、1 枚のスライドに最大限収める・タスク名を短くする・スイムレーンごとに考えるという発想がしにくい。
- **方針転換**
  - ソースを **YAML** にする。YAML に「タスクか分岐か」「繋がっているのは何番か」「ID」「タスク内容」を連番で記載する。
  - 人または AI が YAML を作成・編集し、プログラムが PPTX に変換する。最も効率的な形式が PPTX であれば PPTX を主出力とする。
  - 既存の「XML → .drawio / PPTX」は、処理の名前を「XML から両方に変換する」ことが分かるようにし、必要なら YAML から XML を生成する経路も持つ。

## Constraints

- **入力**: 業務プロセスは YAML で定義する。形式は「タスク／分岐／スタート・ゴール／成果物」「接続先（番号）」「ID」「タスク内容」を連番で記述できるスキーマとする。分岐の種類（条件分岐 vs 並行）、分岐矢印ごとのラベル、システム・サービスへの接続とリクエスト/レスポンス、成果物名などは、必要に応じて YAML スキーマを拡張して表現する。
- **出力**: PPTX は図形（Shape）として編集可能であること。単なる画像の貼り付けは対象外とする。
- **PPTX レイアウト仕様**
  - **スライド内に必ず収める**: 各スライド上の図（アクター名・レーン・タスク・矢印）は、必ずスライドの描画領域内に収める。はみ出しは不可。レーン数・タスク数・列数に応じてスケールや改ページを調整し、常に 1 枚あたりの図がスライド内に収まるようにする。
  - **スライド左右の余白**: スイムレーン（アクター列＋タスク領域）の描画は、**スライドの左端・右端からそれぞれ 10pt 以上**離して配置する。スイムレーンの開始位置をスライドの左端にしない。
  - **描画開始位置**: スライド上部にタイトル・キーメッセージ用の領域を必ず確保する。図（アクター名・レーン・タスク）の描画は左上端ではなく、**スライド上端からおおよそ 25% 下がった位置**から開始する。
  - **左端の開始位置**: アクター名とタスク領域の左からの開始点は近づける。上記 10pt 余白を除き、左余白を抑え、アクター列とタスク描画領域が視覚的に一体になるようにする。
  - **人のタスクの接続**: 人（アクター）に属するタスク同士は、**必ず矢印で繋がっている**こと。孤立した人のタスクが存在しないように、YAML の `next` またはバリデーションで保証する。
  - **アクター（スイムレーン）の名前**: 左側に記載する。**スイムレーンの上下中央**に配置する。
  - **アクター名の表示形式**: アクター名は**点線から 2pt だけ離した長方形（四角）**の中に表示する。長方形の横幅は現状のアクター列の横幅に準拠する。四角内のテキストは**上下中央**で配置する。**アクター部分の点線の上下は 2pt ずつ離して四角があり、等間隔**になるようにする（点線―2pt―四角―2pt―点線の繰り返し）。
  - **アクター数に応じたスケール**: スイムレーンの数に合わせて、各レーンの高さとタスク（正方形）の一辺の長さを調整する。アクターが少ない場合はレーンを高くしタスクを大きく、アクターが多い場合はレーンを低くしタスクを小さくして、スライド内に収まりかつ可読性（最小フォント 10pt を維持）を保つ。
  - **タスク（正方形）のサイズ**: スイムレーンごとの高さに合わせ、タスクの正方形の一辺は**スイムレーンの点線と点線の間の高さの約 60%** とする。レーン高さに比例して正方形も大きくなるようにする。
  - レーンとレーンの間はグレーの点線で区切る。**点線はアクター名がある左端（レーンの左端）まで届くように描画する**。すなわち、点線はタスク領域だけでなくアクター列の左端にも達する。
  - タスクは正方形の四角で表現する。**タスクのラベル（文字）は四角の外ではなく、図形（四角）の内側に配置する**。四角の余白はゼロ、文字は**黒**、**余白なし・折り返しなし**で、最小フォントは 10pt とする。**タスクの四角には影（shadow）を付けない**。
  - **接続は矢印要素で描画する**: タスクから接続先タスクへのフローは、単なる線（Line）ではなく、**矢印の図形（コネクタ／矢印要素）**として描画する。接続先（終点）側に矢印の先端が付き、方向が分かるようにする。線だけの接続は不可。
  - 矢印の**接続ポイント**: タスクの四角の**上下中央**（縦方向の中心軸）の点に結合する。始点・終点とも四角の上下中央に合わせる。
  - **同一レーン内**のタスク間は直線の矢印コネクタ、**異なるレーン**のタスク間は **PPTX の折れ曲がり矢印コネクタ**（直角に曲がる elbow connector）を使い、いずれも**終点に矢印先端**が付いた要素とする。
  - **タスク内の文字**: テキストは図形の上に重ねるのではなく**図形の中に収める**。YAML で明示的に改行が含まれない限り**折り返さない**（1 行のまま表示）。文字色は**黒**、図形のテキスト余白は**なし**とする。白にならないこと。
  - 矢印の距離（タスク間の間隔）は、正方形の一辺と同じ幅とする。
  - **分岐時の列配置**: 分岐が発生した場合は、「分岐前の列」＋「分岐先の新たなタスク用の列」で列を割り当て、分岐先のタスクを同じ列に配置し得るようにする。現状のように分岐先をすべて別列にすると横に間延びするため、分岐前＋分岐先タスク分の列に収め、同一列の再利用を許容して 1 枚のスライドに収まりやすくする。
  - **同一アクターへの分岐先が複数ある場合**: 分岐先が同じアクター（同じスイムレーン）に対応するタスクが複数あるときは、そのスイムレーンの**高さの 90%** をそれらのタスクで分割して使う。横幅は「1 つのタスクのとき」と同じ列幅のままにし、縦方向にのみ分割して複数タスクを並べる。
  - 横幅がいっぱいになる数になったら改ページし、同じ構造（アクター名・レーン・レイアウトルール）で次のスライドに続ける。
  - **スタート・ゴール**: 開始ノードと終了ノードは**正円**で描画する。
  - **分岐の図形**: **条件分岐**は菱形で、その中に **✕** を入れる。**並行処理**（AND 分岐）は菱形で、その中に **＋** を入れる。
  - **分岐矢印のラベル**: 分岐した際の矢印に、**何の説明か**を表すテキスト（例: Yes / No、承認 / 差し戻し）を付与できるようにする。YAML で分岐先ごとにラベルを指定し、PPTX 上では矢印の近くにそのテキストを表示する。
  - **ループ**: タスクはどこかで分岐して**最初（スタート）に戻る**可能性がある。YAML の `next` で開始ノードの ID を参照できるようにし、レイアウト上もループが描画できるようにする。
  - **成果物・データ**: 成果物を作成したり保存したりするノードは、**フローチャートの「データ」図形**（一般的なフローチャート記号のデータ形状）で描画する。データ図形の**中に成果物名**を記載する。YAML でノードタイプまたは属性で「成果物」を指定できるようにする。
  - **システムレーンとシステム接続**
    - **システム側のデータ表現**: 人タスクからシステムへの入出力の方向性は、**システム側**にフローチャート図の**磁気ディスク**（ストレージ）図形を使ってデータの向きを表す。
    - **リクエスト**: 人のタスクからシステムのサービス名（またはサービスを表す図形）へは**点線**で描画する。**人のタスク側の端点は ○（円）**、**サービス側は矢印で下向き**に接続する。
    - **レスポンス**: システムから人への戻りは、**下から上**に向かう**点線**で、同スタイル（サービス側は矢印、人側は ○ または規定の端点）で描画する。
    - **サービスは 1 レーンあたり 1 つ**: システムレーン内では**サービスは 1 つしか描かない**。複数の人タスクが同じシステムに接続する場合は、**1 つのサービスに対して複数のタスクから上下の点線**が伸びる形にする。
    - **列・ラインがずれる場合**: 人タスクとサービスが同じ列にないときは、点線は **elbow（L 字型）** を使い、縦・横の折れ線で接続する。
- **既存パイプライン**: 「XML → .drawio」「XML → PPTX」は、名前を「XML から両方に変換する」ことが分かるようにする（モジュール名・CLI 表記の見直し）。
- 使用言語・ランタイムは実装時に判断してよい。Python を選ぶ場合は **uv** を使用する。
- **提供形態**: Docker 利用者向けに、ローカル YAML をビルド（YAML → PPTX 変換）できる **Docker Compose** 環境を用意する。利用者の環境構築負荷を減らし、Docker があればすぐ使えるようにする。Compose でコンテナを増やしたり並列実行したりできる構成とする。
- **Docker ワークフロー**: 指定の **input** フォルダに変換前のファイル（YAML 等）を置き、`docker compose run` を実行すると変換が走り、変換後のファイル（PPTX 等）が **output** フォルダに出力される。入力と出力の置き場所が明確であること。

## Definition of Done

**運用**: 既存タスクを更新して新たな要件を追加した場合は、該当する DoD を新規追加して `[ ]` にするか、既存 DoD のチェックを外し `[ ]` にすること。Plan を見た人が「何を変更すればよいか」分かるようにする。

- [x] **YAML スキーマ**: タスク／分岐・接続先（番号）・ID・タスク内容を連番で記述できる YAML 形式を定義し、ドキュメント化している
- [x] **YAML → PPTX**: YAML を入力として、上記「PPTX レイアウト仕様」を満たす編集可能な PPTX を生成できる
- [x] **レイアウト**: 描画開始は上から約 25%（タイトル・キーメッセージ用領域確保）、アクター名は左、レーン間はグレー点線、タスクは正方形・余白ゼロ・最小 10pt・影なし、矢印間隔＝正方形一辺、改ページ時も同じ構造で続く
- [x] **アクター数に応じたスケール**: スイムレーンの数に合わせてレーンの高さとタスク（正方形）のサイズが調整され、アクターが少ないときはレーン・タスクが大きく、多いときは小さく収まっている。最小フォント 10pt は維持する。
- [x] **タスク正方形の比率**: 各タスクの正方形の一辺が、そのスイムレーンの点線と点線の間の高さの約 60% になるように描画されている。
- [x] **左端開始位置**: アクター名とタスク領域の左からの開始点が近く、左余白が抑えられて一体感がある。
- [ ] **スライド左右10pt余白**: スイムレーン（アクター列＋タスク領域）がスライドの左端・右端からそれぞれ 10pt 以上離して配置されている。
- [ ] **人のタスクの接続**: 人に属するタスク同士が必ず矢印で繋がっており、孤立した人のタスクが存在しない（YAML 検証または生成結果で確認可能）。
- [ ] **アクター名の位置**: アクター名がスイムレーンの上下中央に配置されている。
- [ ] **アクター名の四角**: アクター名が点線から 2pt 離した長方形内にあり、幅はアクター列幅に準拠し、テキストは上下中央。点線の上下 2pt ずつ離して四角があり等間隔になっている。
- [x] **スタート・ゴール**: 開始ノード・終了ノードが正円で描画されている。
- [ ] **分岐図形**: 条件分岐が菱形＋✕、並行処理が菱形＋＋で描画されている。
- [ ] **分岐矢印のラベル**: 分岐した矢印に説明テキスト（Yes/No 等）が表示できる。
- [ ] **ループ**: 分岐してスタートに戻るフローが YAML で定義でき、PPTX 上でループとして描画されている。
- [ ] **成果物**: 成果物ノードがフローチャートのデータ図形で描画され、中に成果物名が記載されている。
- [ ] **システム接続**: システム側に磁気ディスク図形でデータ方向を表示。人→システムは点線・人側○・サービス側矢印下向き、レスポンスは下→上点線。システムレーン内はサービス1つに複数タスクから点線。列ずれ時は elbow（L字）点線。
- [x] **点線の範囲**: レーン間のグレー点線が、タスク領域だけでなくアクター名がある左端（レーンの左端）まで届いて描画されている。
- [x] **同一アクターへの複数分岐**: 分岐先が同じアクター（同じスイムレーン）に複数タスクがある場合、そのレーンの高さの 90% を縦に分割してタスクを配置し、横幅は 1 タスク時と同じ列幅で描画されている。
- [x] **スライドに必ず収まる**: 生成された各スライドで、図（アクター名・レーン・タスク・矢印）がスライドの描画領域からはみ出していない。スケール・改ページにより常にスライド内に収まっている。
- [x] **分岐時の列配置**: 分岐発生時は「分岐前の列＋分岐先タスク用の列」で配置し、分岐先を同一列に配置し得るようにして横に間延びしないレイアウトになっている
- [x] **描画開始位置**: 図の描画がスライド上端からおおよそ 25% 下がった位置から開始している（タイトル・キーメッセージ用の上部領域が確保されている）
- [x] **タスクの影**: タスクの四角に影（shadow）が付いていない
- [x] **矢印**: タスク同士の接続が PPTX 上で**矢印要素（コネクタ）**として描画され、接続先（終点）に矢印の先端が付いている。単なる線（Line）での接続ではない。
- [x] **矢印の形状**: 各接続が矢印付きコネクタで描画され、終点側に矢印先端が表示されている（線のみの描画は不備とする）
- [x] **矢印の接続点**: 矢印がタスクの四角の上下中央のポイントに結合されている
- [x] **矢印の種類**: 同一レーン内は直線矢印、異なるレーン間は PPTX の折れ曲がり矢印（直角コネクタ）で描画されている
- [x] **タスク文字の配置**: タスクの文字は四角の上に重ねた別要素ではなく、**図形（四角）の内側**に配置されている。黒文字・余白なし・折り返しなしで、最小 10pt で表示されている
- [x] **タスク文字の折り返し**: タスク内の文字は、明示的改行がない限り折り返さず 1 行で表示されている
- [x] **タスク文字色**: タスクの四角内の文字色が白ではなく、視認できる色（黒または濃いグレー等）になっている
- [x] **CLI/API**: YAML → PPTX を実行できる CLI または API が存在する
- [x] **検証**: 生成 PPTX に図形が含まれることを確認できる手段がある（図形 0 件の検知・警告またはテストでのアサート）
- [x] **プレビュー**: 出力の見た目を確認する手段がある（プレビュー画像、スライド/図形一覧表示、または手順の明記のいずれか）
- [x] **名前の整理**: XML から .drawio / PPTX の両方に変換する処理の名前を、実態に合わせて変更している
- [x] **Docker Compose**: 指定の **input** に変換前（YAML 等）を置き、`docker compose run` で変換し、変換後（PPTX 等）が **output** フォルダに出力される `docker-compose` 設定があり、必要に応じてコンテナを増やせる状態である
- [x] **入出力ディレクトリ名（input / output）**: 変換前ディレクトリを **input**、変換後を **output** として用意し、Docker・CLI・README 等で一貫して使用している（従来の src/gen からの変更を実施済みであること）

## Assumptions

- YAML は BPMN 風の業務プロセス（スイムレーン・タスク・分岐・フロー）を表現するのに十分な情報を含むと仮定する。
- 複数ページにまたがる場合も、1 ページ目と同じレイアウトルール（アクター名・点線・正方形・矢印間隔）を維持する。
- 既存の「mxGraph XML を入力とする」経路は、当面は残し、YAML と併存させることを想定する（DR で要不要を判断可能）。
- Docker 利用者には、uv や Node のローカル導入なしに、Docker Compose で YAML ビルドができることを想定する。

## Decision Required

| ID | 内容 | 選択肢 | Priority |
|----|------|--------|----------|
| DR-001 | 既存の XML→.drawio / XML→PPTX の扱い | 残す（YAML は新コマンドで追加）/ 名前だけ整理して残す / 段階的に YAML に一本化 | P0 |
| DR-002 | YAML から mxGraph 用 XML を生成するか | する（YAML→XML→.drawio を提供）/ しない（PPTX のみ） | P1 |
| DR-003 | プレビュー方法 | 手動で PowerPoint で開く手順をドキュメント化 / CLI でスライド・図形一覧表示 / プレビュー画像を自動生成 | P2 |
| DR-004 | 実装言語・ランタイム | Python（uv）/ Node.js（Volta）/ その他 | P0 |

## References

- 既存: `process_to_pptx/`（xml2pptx.py, xml2drawio.py, cli.py）
- 入力例: `input.xml`（mxGraph 互換 XML）。YAML は **input** フォルダに置く（例は `docs/examples/` にもある）

---
Created: 2025-02-07
Updated: 2025-02-08
Owner: x4066x
Status: draft
---

# 実装計画: YAML 駆動の業務プロセス図 → 編集可能な PPTX

## Goal

YAML で定義した業務プロセス（BPMN 風・スイムレーン）を、編集可能な図形として PPTX に変換する。YAML は人または AI が作成・編集し、プログラムが PPTX（必要に応じて mxGraph XML も）に変換する。最も効率的な出力が PPTX であれば PPTX を主とする。

## Background / Motivation

- **現状の課題**
  - 実態は「mxGraph XML から直接 PPTX に変換」しているが、名前や説明が「drawio から pptx」のように見え、紛らわしい。
  - 出力をそのまま使おうとしたところ、矢印が繋がっていないなど微妙な使い方になっていた。
  - BPMN で業務プロセスを作る際、タスクが増えると横に伸びるだけで、1 枚のスライドに最大限収める・タスク名を短くする・スイムレーンごとに考えるという発想がしにくい。
- **方針転換**
  - ソースを **YAML** にする。YAML に「タスクか分岐か」「繋がっているのは何番か」「ID」「タスク内容」を連番で記載する。
  - 人または AI が YAML を作成・編集し、プログラムが PPTX に変換する。最も効率的な形式が PPTX であれば PPTX を主出力とする。
  - 既存の「XML → .drawio / PPTX」は、処理の名前を「XML から両方に変換する」ことが分かるようにし、必要なら YAML から XML を生成する経路も持つ。

## Constraints

- **入力**: 業務プロセスは YAML で定義する。形式は「タスク／分岐」「接続先（番号）」「ID」「タスク内容」を連番で記述できるスキーマとする。
- **出力**: PPTX は図形（Shape）として編集可能であること。単なる画像の貼り付けは対象外とする。
- **PPTX レイアウト仕様**
  - **描画開始位置**: スライド上部にタイトル・キーメッセージ用の領域を必ず確保する。図（アクター名・レーン・タスク）の描画は左上端ではなく、**スライド上端からおおよそ 25% 下がった位置**から開始する。
  - アクター（スイムレーン）の名前は左側に記載する。
  - レーンとレーンの間はグレーの点線で区切る。
  - タスクは正方形の四角で表現する。余白はゼロの四角に、最小フォントは 10pt で文字を描く。**タスクの四角には影（shadow）を付けない**。
  - **接続は矢印要素で描画する**: タスクから接続先タスクへのフローは、単なる線（Line）ではなく、**矢印の図形（コネクタ／矢印要素）**として描画する。接続先（終点）側に矢印の先端が付き、方向が分かるようにする。線だけの接続は不可。
  - 矢印の**接続ポイント**: タスクの四角の**上下中央**（縦方向の中心軸）の点に結合する。始点・終点とも四角の上下中央に合わせる。
  - **同一レーン内**のタスク間は直線の矢印コネクタ、**異なるレーン**のタスク間は **PPTX の折れ曲がり矢印コネクタ**（直角に曲がる elbow connector）を使い、いずれも**終点に矢印先端**が付いた要素とする。
  - タスク内の文字: YAML で明示的に改行が含まれない限り**折り返さない**（1 行のまま表示）。改行されない限りそのまま 1 行で描画する。
  - タスクの四角の**文字色**は視認できる色（黒または濃いグレーなど）とする。白にならないこと。
  - 矢印の距離（タスク間の間隔）は、正方形の一辺と同じ幅とする。
  - 横幅がいっぱいになる数になったら改ページし、同じ構造（アクター名・レーン・レイアウトルール）で次のスライドに続ける。
- **既存パイプライン**: 「XML → .drawio」「XML → PPTX」は、名前を「XML から両方に変換する」ことが分かるようにする（モジュール名・CLI 表記の見直し）。
- 使用言語・ランタイムは実装時に判断してよい。Python を選ぶ場合は **uv** を使用する。
- **提供形態**: Docker 利用者向けに、ローカル YAML をビルド（YAML → PPTX 変換）できる **Docker Compose** 環境を用意する。利用者の環境構築負荷を減らし、Docker があればすぐ使えるようにする。Compose でコンテナを増やしたり並列実行したりできる構成とする。
- **Docker ワークフロー**: 指定の **input** フォルダに変換前のファイル（YAML 等）を置き、`docker compose run` を実行すると変換が走り、変換後のファイル（PPTX 等）が **output** フォルダに出力される。入力と出力の置き場所が明確であること。

## Definition of Done

**運用**: 既存タスクを更新して新たな要件を追加した場合は、該当する DoD を新規追加して `[ ]` にするか、既存 DoD のチェックを外し `[ ]` にすること。Plan を見た人が「何を変更すればよいか」分かるようにする。

- [x] **YAML スキーマ**: タスク／分岐・接続先（番号）・ID・タスク内容を連番で記述できる YAML 形式を定義し、ドキュメント化している
- [x] **YAML → PPTX**: YAML を入力として、上記「PPTX レイアウト仕様」を満たす編集可能な PPTX を生成できる
- [x] **レイアウト**: 描画開始は上から約 25%（タイトル・キーメッセージ用領域確保）、アクター名は左、レーン間はグレー点線、タスクは正方形・余白ゼロ・最小 10pt・影なし、矢印間隔＝正方形一辺、改ページ時も同じ構造で続く
- [x] **描画開始位置**: 図の描画がスライド上端からおおよそ 25% 下がった位置から開始している（タイトル・キーメッセージ用の上部領域が確保されている）
- [x] **タスクの影**: タスクの四角に影（shadow）が付いていない
- [x] **矢印**: タスク同士の接続が PPTX 上で**矢印要素（コネクタ）**として描画され、接続先（終点）に矢印の先端が付いている。単なる線（Line）での接続ではない。
- [x] **矢印の形状**: 各接続が矢印付きコネクタで描画され、終点側に矢印先端が表示されている（線のみの描画は不備とする）
- [x] **矢印の接続点**: 矢印がタスクの四角の上下中央のポイントに結合されている
- [x] **矢印の種類**: 同一レーン内は直線矢印、異なるレーン間は PPTX の折れ曲がり矢印（直角コネクタ）で描画されている
- [x] **タスク文字の折り返し**: タスク内の文字は、明示的改行がない限り折り返さず 1 行で表示されている
- [x] **タスク文字色**: タスクの四角内の文字色が白ではなく、視認できる色（黒または濃いグレー等）になっている
- [x] **CLI/API**: YAML → PPTX を実行できる CLI または API が存在する
- [x] **検証**: 生成 PPTX に図形が含まれることを確認できる手段がある（図形 0 件の検知・警告またはテストでのアサート）
- [x] **プレビュー**: 出力の見た目を確認する手段がある（プレビュー画像、スライド/図形一覧表示、または手順の明記のいずれか）
- [x] **名前の整理**: XML から .drawio / PPTX の両方に変換する処理の名前を、実態に合わせて変更している
- [x] **Docker Compose**: 指定の **input** に変換前（YAML 等）を置き、`docker compose run` で変換し、変換後（PPTX 等）が **output** フォルダに出力される `docker-compose` 設定があり、必要に応じてコンテナを増やせる状態である
- [x] **入出力ディレクトリ名（input / output）**: 変換前ディレクトリを **input**、変換後を **output** として用意し、Docker・CLI・README 等で一貫して使用している（従来の src/gen からの変更を実施済みであること）

## Assumptions

- YAML は BPMN 風の業務プロセス（スイムレーン・タスク・分岐・フロー）を表現するのに十分な情報を含むと仮定する。
- 複数ページにまたがる場合も、1 ページ目と同じレイアウトルール（アクター名・点線・正方形・矢印間隔）を維持する。
- 既存の「mxGraph XML を入力とする」経路は、当面は残し、YAML と併存させることを想定する（DR で要不要を判断可能）。
- Docker 利用者には、uv や Node のローカル導入なしに、Docker Compose で YAML ビルドができることを想定する。

## Decision Required

| ID | 内容 | 選択肢 | Priority |
|----|------|--------|----------|
| DR-001 | 既存の XML→.drawio / XML→PPTX の扱い | 残す（YAML は新コマンドで追加）/ 名前だけ整理して残す / 段階的に YAML に一本化 | P0 |
| DR-002 | YAML から mxGraph 用 XML を生成するか | する（YAML→XML→.drawio を提供）/ しない（PPTX のみ） | P1 |
| DR-003 | プレビュー方法 | 手動で PowerPoint で開く手順をドキュメント化 / CLI でスライド・図形一覧表示 / プレビュー画像を自動生成 | P2 |
| DR-004 | 実装言語・ランタイム | Python（uv）/ Node.js（Volta）/ その他 | P0 |

## References

- 既存: `process_to_pptx/`（xml2pptx.py, xml2drawio.py, cli.py）
- 入力例: `input.xml`（mxGraph 互換 XML）、YAML 例は `docs/examples/` にあり
